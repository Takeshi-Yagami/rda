<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>R 打</title>
    <style>
        /* --- 全体のレイアウト --- */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #222;
            color: #fff;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { margin: 10px 0; font-size: 20px; color: #888; }

        /* --- ゲーム画面の枠 --- */
        #game-stage {
            position: relative;
            width: 800px;
            height: 450px;
            background: #333;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 4px solid #555;
        }

        /* --- HUD --- */
        #hud-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 24px;
            background: rgba(0,0,0,0.3);
            z-index: 10;
        }
        .scale{
            display: flex;
            width: 33.33%;
            flex-basis: 33%;;
        }
        .scale1{
            justify-content: flex-start;
        }
        .scale2{
            justify-content: center;
        }
        .scale3{
            justify-content: flex-end;
        }

        #reset-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 15px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }
        #reset-btn:hover { background: #ff6666; }

        #time-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: #444;
        }
        #time-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc6a);
            transition: width 0.1s linear;
        }

        /* --- お皿と文字 --- */
        #plate-area {
            position: relative;
            background: #fdfdfd;
            color: #333;
            width: 600px;
            padding: 30px;
            border-radius: 50px;
            text-align: center;
            box-shadow: 0 8px 0 #ccc, 0 15px 20px rgba(0,0,0,0.3);
            transform: scale(1);
            transition: transform 0.1s;
        }
        .bounce { animation: bounceAnim 0.1s; }
        @keyframes bounceAnim { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

        .shake-screen { animation: shakeAnim 0.3s; }
        @keyframes shakeAnim { 
            0% { transform: translate(0, 0); } 
            25% { transform: translate(-5px, 0); } 
            75% { transform: translate(5px, 0); } 
            100% { transform: translate(0, 0); } 
        }

        #target-display { font-size: 48px; font-weight: bold; margin-bottom: 5px; min-height: 60px; line-height: 1.2; word-break: break-all;}
        #romaji-display { font-size: 24px; color: #888; font-family: monospace; height: 30px;}

        .typed { color: #ccc; }
        .current { border-bottom: 3px solid #ff9900; color: #333; }
        .remaining { color: #333; opacity: 0.6; }

        /* --- コンボ --- */
        #combo-display {
            position: absolute;
            right: 50px;
            bottom: 50px;
            font-size: 30px;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 2px 2px 0 #000;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .show-combo { opacity: 1 !important; }

        /* --- オーバーレイ --- */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            transition: opacity 0.3s;
        }
        #overlay-title { font-size: 40px; margin-bottom: 20px; font-weight: bold; }
        #overlay-btn {
            padding: 15px 40px;
            font-size: 24px;
            background: #ff9900;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 #cc7a00;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        #overlay-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #cc7a00; }
        .hidden { display: none !important; }

        /* --- 設定エリア開閉ボタン --- */
        #toggle-config-btn {
            margin-top: 20px;
            background: #444;
            color: #ccc;
            border: 1px solid #666;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        #toggle-config-btn:hover { background: #555; color: white; }

        /* --- 設定エリア --- */
        #config-area {
            display: none; 
            margin-top: 15px;
            background: #eee;
            padding: 20px;
            border-radius: 10px;
            width: 600px;
            color: #333;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        textarea { width: 100%; height: 80px; margin-top: 5px; box-sizing: border-box; }
        .config-btns { margin-top: 10px; }
        button.sm-btn { padding: 5px 15px; font-size: 14px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button.save-btn { background: #0088cc; }
        button.save-btn:hover { background: #0099ee; }
    </style>
</head>
<body>

    <h1>R 打</h1>

    <div id="game-stage">
        <div id="hud-top">
            <div class="scale scale1"><div id="score-display">SCORE: 0</div></div>
            <div class="scale scale2"><button id="reset-btn" onclick="gameManager.resetGame()">STOP / RESET</button></div>
            <div class="scale scale3"><div id="timer-text">60.0</div></div>
        </div>

        <div id="plate-area">
            <div id="target-display">Ready?</div>
            <div id="romaji-display"></div>
        </div>

        <div id="combo-display">0 COMBO!</div>

        <div id="time-bar-container">
            <div id="time-bar"></div>
        </div>

        <div id="overlay">
            <div id="overlay-title">Rを正しく入力しよう!</div>
            <div id="result-score" style="font-size: 20px; margin-bottom: 20px; display:none;"></div>
            <button id="overlay-btn" onclick="gameManager.startGame()">START</button>
            <p style="font-size:14px; margin-top:15px; color:#aaa;">Spaceキーでもスタートできます</p>
        </div>
    </div>

    <button id="toggle-config-btn" onclick="toggleConfig()">▼ 単語リスト設定を開く</button>

    <div id="config-area">
        <h3 style="margin-top:0;">単語リスト編集</h3>
        <p style="font-size:12px; color:#666; margin-bottom:5px;">
            【制限】漢字・カタカナは使えません。<br>
            ひらがな、半角英数字、記号のみ入力してください。
        </p>
        <textarea id="word-input"></textarea>
        <div class="config-btns">
            <button class="sm-btn save-btn" onclick="saveData()">保存して閉じる</button>
            <button class="sm-btn" onclick="resetDefault()" style="margin-left:10px;">初期化して閉じる</button>
        </div>
    </div>

    <script>
        const GAME_DURATION = 30;

        const DEFAULT_WORDS = [
            "function", "library", "return", "if", "else", "for", "while", "TRUE", "FALSE", "NULL", 
            "NA", "Inf", "next", "break", "c", "list", "vector", "matrix", "data.frame", "factor", 
            "length", "names", "dim", "nrow", "ncol", "print", "cat", "paste", "paste0", "sprintf", 
            "seq", "rep", "rev", "sort", "order", "unique", "sum", "mean", "median", "sd", 
            "var", "min", "max", "range", "summary", "apply", "lapply", "sapply", "vapply", "tapply", 
            "class", "typeof", "str", "head", "tail", "rm", "gc", "install.packages", "setwd", "getwd", 
            "tidyverse", "dplyr", "ggplot2", "filter", "select", "mutate", "arrange", "rename", "group_by", 
            "summarise", "ungroup", "pull", "distinct", "slice", "count", "bind_rows", "left_join", "inner_join", 
            "pivot_longer", "pivot_wider", "ggplot", "aes", "geom_point", "geom_line", "geom_bar", "geom_histogram", 
            "read.csv", "read_csv", "write_csv", "readRDS", "saveRDS", "df", "data", "x", "y", "i", 
            "j", "res", "result", "value", "path", "na.rm"
        ];

        // ---------------------------------------------------------
        // 1. ローマ字変換テーブル（一部のみ抜粋）
        // 実際には「ぁ〜ん」まですべて定義する必要があります
        // ---------------------------------------------------------
        const ROMAJI_MAP = {
            'あ': ['a', 'aa', 'ah'],
            'い': ['i', 'ii', 'ih', 'yi'],
            'う': ['u', 'uu', 'uh', 'wu', 'whu'],
            'え': ['e', 'ee', 'eh'],
            'お': ['o', 'oo', 'oh'],
            'か': ['ka', 'ca'],
            'き': ['ki'],
            'く': ['ku', 'cu', 'qu'],
            'け': ['ke'],
            'こ': ['ko', 'co'],
            'さ': ['sa'],
            'し': ['shi', 'si', 'ci'],
            'す': ['su'],
            'せ': ['se'],
            'そ': ['so'],
            'た': ['ta'],
            'ち': ['chi', 'ti'],
            'つ': ['tsu', 'tu'],
            'て': ['te'],
            'と': ['to'],
            'な': ['na'],
            'に': ['ni'],
            'ぬ': ['nu'],
            'ね': ['ne'],
            'の': ['no'],
            'は': ['ha'],
            'ひ': ['hi'],
            'ふ': ['fu', 'hu'],
            'へ': ['he'],
            'ほ': ['ho'],
            'ま': ['ma'],
            'み': ['mi'],
            'む': ['mu'],
            'め': ['me'],
            'も': ['mo'],
            'や': ['ya'],
            'ゆ': ['yu'],
            'よ': ['yo'],
            'ら': ['ra'],
            'り': ['ri'],
            'る': ['ru'],
            'れ': ['re'],
            'ろ': ['ro'],
            'わ': ['wa'],
            'を': ['wo', 'o'],
            'ん': ['nn', 'xn', 'n'], // ※「ん」のn一回打ちは次に来る文字依存など複雑ですが、今回は簡易化
            'が': ['ga'],
            'ぎ': ['gi'],
            'ぐ': ['gu'],
            'げ': ['ge'],
            'ご': ['go'],
            'ざ': ['za'],
            'じ': ['ji', 'zi'],
            'ず': ['zu'],
            'ぜ': ['ze'],
            'ぞ': ['zo'],
            'だ': ['da'],
            'ぢ': ['ji', 'di'],
            'づ': ['zu', 'du'],
            'で': ['de'],
            'ど': ['do'],
            'ば': ['ba'],
            'び': ['bi'],
            'ぶ': ['bu'],
            'べ': ['be'],
            'ぼ': ['bo'],
            'ぱ': ['pa'],
            'ぴ': ['pi'],
            'ぷ': ['pu'],
            'ぺ': ['pe'],
            'ぽ': ['po'],
            'ゃ': ['lya', 'xya'],
            'ゅ': ['lyu', 'xyu'],
            'ょ': ['lyo', 'xyo'],
            'っ': ['ltu', 'xtu', 'ltsu'], // 小さい「っ」
            'ー': ['-'], // 長音記号
            '、': [','],
            '。': ['.']
        };

        class TypingEngine {
            constructor() {
                this.targetText = "";
                this.charIndex = 0;
                this.currentCandidates = [];
                this.typedString = "";
            }

            setWord(text) {
                this.targetText = text;
                this.charIndex = 0;
                this.typedString = "";
                this.updateCandidates();
            }

            updateCandidates() {
                while (this.charIndex < this.targetText.length && this.targetText[this.charIndex] === ' ') {
                    this.charIndex++;
                }

                if (this.isFinished()) return;
                
                const char = this.targetText[this.charIndex];
                if (ROMAJI_MAP[char]) {
                    this.currentCandidates = [...ROMAJI_MAP[char]];
                } else {
                    this.currentCandidates = [char.toLowerCase()];
                }
            }

            input(key) {
                if (this.isFinished()) return false;
                const normalizedKey = key.toLowerCase();
                const nextInput = this.typedString + normalizedKey;
                const validCandidates = this.currentCandidates.filter(c => c.startsWith(nextInput));

                if (validCandidates.length > 0) {
                    this.typedString = nextInput;
                    this.currentCandidates = validCandidates;
                    if (this.currentCandidates.includes(this.typedString)) {
                        this.nextChar();
                    }
                    return true;
                }
                return false;
            }

            nextChar() {
                this.charIndex++;
                this.typedString = "";
                if (!this.isFinished()) this.updateCandidates();
            }

            isFinished() {
                return this.charIndex >= this.targetText.length;
            }

            getStatus() {
                const finished = this.targetText.substring(0, this.charIndex);
                const current = this.targetText[this.charIndex] || "";
                const remaining = this.targetText.substring(this.charIndex + 1);
                let guide = "";
                if (!this.isFinished()) {
                    guide = this.typedString + this.currentCandidates[0].substring(this.typedString.length);
                }
                return { finished, current, remaining, guide };
            }
        }

        class GameManager {
            constructor() {
                this.engine = new TypingEngine();
                this.wordList = [];
                this.score = 0;
                this.combo = 0;
                this.timeLeft = GAME_DURATION;
                this.isPlaying = false;
                this.timerId = null;
                this.lastWordIndex = null;

                this.dom = {
                    score: document.getElementById('score-display'),
                    timerText: document.getElementById('timer-text'),
                    timerBar: document.getElementById('time-bar'),
                    target: document.getElementById('target-display'),
                    romaji: document.getElementById('romaji-display'),
                    plate: document.getElementById('plate-area'),
                    combo: document.getElementById('combo-display'),
                    overlay: document.getElementById('overlay'),
                    overlayTitle: document.getElementById('overlay-title'),
                    overlayBtn: document.getElementById('overlay-btn'),
                    resultScore: document.getElementById('result-score'),
                    stage: document.getElementById('game-stage'),
                    resetBtn: document.getElementById('reset-btn')
                };

                this.loadWords();
            }

            loadWords() {
                const saved = localStorage.getItem('typing-words');
                this.wordList = saved ? JSON.parse(saved) : [...DEFAULT_WORDS];
                document.getElementById('word-input').value = this.wordList.join('\n');
            }

            startGame() {
                this.score = 0;
                this.combo = 0;
                this.timeLeft = GAME_DURATION;
                this.isPlaying = true;
                this.lastWordIndex = null;
                
                this.updateHUD();
                this.dom.overlay.classList.add('hidden');
                this.dom.resultScore.style.display = 'none';
                this.dom.resetBtn.style.display = 'block';
                
                this.nextWord();
                
                if (this.timerId) clearInterval(this.timerId);
                this.timerId = setInterval(() => this.tick(), 100);
            }

            resetGame() {
                this.isPlaying = false;
                clearInterval(this.timerId);
                this.dom.overlayTitle.textContent = "TYPING GAME";
                this.dom.resultScore.style.display = 'none';
                this.dom.overlayBtn.textContent = "START";
                this.dom.overlay.classList.remove('hidden');
                this.dom.resetBtn.style.display = 'none';
                this.dom.target.textContent = "Ready?";
                this.dom.romaji.textContent = "";
                this.dom.combo.classList.remove('show-combo');
                this.dom.timerBar.style.width = "100%";
                this.dom.timerBar.style.background = 'linear-gradient(90deg, #00ff88, #00cc6a)';
                this.dom.timerText.textContent = GAME_DURATION.toFixed(1);
            }

            tick() {
                this.timeLeft -= 0.1;
                if (this.timeLeft <= 0) {
                    this.timeLeft = 0;
                    this.finishGame();
                }
                this.updateHUD();
            }

            finishGame() {
                this.isPlaying = false;
                clearInterval(this.timerId);
                
                this.dom.overlayTitle.textContent = "TIME UP!";
                this.dom.resultScore.textContent = `SCORE: ${this.score}`;
                this.dom.resultScore.style.display = 'block';
                this.dom.overlayBtn.textContent = "RETRY";
                this.dom.overlay.classList.remove('hidden');
                this.dom.resetBtn.style.display = 'none';
            }

            nextWord() {
                if (this.wordList.length === 0) return;
                let nextIndex;
                if (this.wordList.length === 1) {
                    nextIndex = 0;
                } else {
                    do {
                        nextIndex = Math.floor(Math.random() * this.wordList.length);
                    } while (nextIndex === this.lastWordIndex);
                }
                this.lastWordIndex = nextIndex;
                const word = this.wordList[nextIndex];
                this.engine.setWord(word);
                this.render();
            }

            handleInput(key) {
                if (!this.isPlaying) return;

                const isCorrect = this.engine.input(key);
                
                if (isCorrect) {
                    this.score += 10 + (this.combo * 2);
                    this.combo++;
                    this.playPlateAnimation();
                    
                    if (this.engine.isFinished()) {
                        this.score += 100;
                        this.nextWord();
                    }
                } else {
                    this.combo = 0;
                    this.playShakeAnimation();
                }
                this.updateHUD();
                this.render();
            }

            updateHUD() {
                this.dom.score.textContent = `SCORE: ${this.score}`;
                this.dom.timerText.textContent = this.timeLeft.toFixed(1);
                
                if (this.combo > 1) {
                    this.dom.combo.textContent = `${this.combo} COMBO!`;
                    this.dom.combo.classList.add('show-combo');
                } else {
                    this.dom.combo.classList.remove('show-combo');
                }

                const percent = (this.timeLeft / GAME_DURATION) * 100;
                this.dom.timerBar.style.width = `${percent}%`;
                
                if (percent < 20) this.dom.timerBar.style.background = '#ff4444';
                else this.dom.timerBar.style.background = 'linear-gradient(90deg, #00ff88, #00cc6a)';
            }

            render() {
                const { finished, current, remaining, guide } = this.engine.getStatus();
                this.dom.target.innerHTML = 
                    `<span class="typed">${finished}</span>` +
                    `<span class="current">${current}</span>` +
                    `<span class="remaining">${remaining}</span>`;
                
                if (!this.engine.isFinished()) {
                    const tLen = this.engine.typedString.length;
                    this.dom.romaji.innerHTML = 
                        `<span class="typed">${guide.substring(0, tLen)}</span>` +
                        guide.substring(tLen);
                } else {
                    this.dom.romaji.innerHTML = "";
                }
            }

            playPlateAnimation() {
                this.dom.plate.classList.remove('bounce');
                void this.dom.plate.offsetWidth;
                this.dom.plate.classList.add('bounce');
            }
            
            playShakeAnimation() {
                this.dom.stage.classList.remove('shake-screen');
                void this.dom.stage.offsetWidth;
                this.dom.stage.classList.add('shake-screen');
            }
        }

        const gameManager = new GameManager();

        document.addEventListener('keydown', (e) => {
            const configArea = document.getElementById('config-area');
            if (configArea.style.display === 'block') return;

            if (e.code === 'Space' && !gameManager.isPlaying) {
                e.preventDefault();
                gameManager.startGame();
                return;
            }

            if (e.key.length === 1) {
                gameManager.handleInput(e.key);
            }
        });

        function toggleConfig() {
            const area = document.getElementById('config-area');
            const btn = document.getElementById('toggle-config-btn');
            
            if (area.style.display === 'none' || area.style.display === '') {
                area.style.display = 'block';
                btn.textContent = "▲ 設定を閉じる";
            } else {
                area.style.display = 'none';
                btn.textContent = "▼ 単語リスト設定を開く";
                btn.blur();
            }
        }

        window.saveData = function() {
            const val = document.getElementById('word-input').value;
            const list = val.split('\n').map(w => w.trim()).filter(w=>w);
            
            if(list.length === 0){
                alert("単語を1つ以上入力してください。");
                return;
            }

            const invalidCharRegex = /[^\u0020-\u007E\u3040-\u309Fー、。]/;
            const invalidWords = [];
            for (let word of list) {
                if (invalidCharRegex.test(word)) {
                    invalidWords.push(word);
                }
            }

            if (invalidWords.length > 0) {
                alert("保存できませんでした。\n禁止文字が含まれています：\n" + invalidWords.join(", "));
                return;
            }

            gameManager.wordList = list;
            localStorage.setItem('typing-words', JSON.stringify(list));
            alert("保存しました。");
            toggleConfig();
        };

        // ★修正点：初期化後に自動で設定画面を閉じる
        window.resetDefault = function() {
            if(confirm("リストを初期状態に戻しますか？")) {
                localStorage.removeItem('typing-words');
                gameManager.loadWords();
                alert("初期化しました。");
                // 設定画面を閉じる
                toggleConfig();
            }
        };

    </script>
</body>
</html>